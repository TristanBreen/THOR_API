name: Deploy API

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Backup data, pull latest code, and restart Docker
        run: |
          set -euo pipefail
          REPO="/home/tristan/API/API_Repoed/THOR_API"
          DOCKER_DIR="/home/tristan/Docker"
          BACKUP_DIR="/home/tristan/API/API_Repoed/deploy_backups"

          echo "== Deploy started at $(date -u) =="

          cd "$REPO"

          # Create backup directory if it doesn't exist
          mkdir -p "$BACKUP_DIR"

          # Backup pain.csv and seizures.csv
          TIMESTAMP=$(date -u +%Y%m%d%H%M%S)
          for FILE in pain.csv seizures.csv; do
            if [ -f "$FIL]()
