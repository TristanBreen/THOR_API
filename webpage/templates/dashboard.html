<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Seizure Monitoring Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js" defer></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Georgia', 'Garamond', serif; background: linear-gradient(135deg, #1a4d2e 0%, #2d5a3d 50%, #3d6b4f 100%); min-height: 100vh; padding: 20px; color: #2d3e35; }
        .container { max-width: 1600px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #8b9a7c 0%, #a0b896 100%); padding: 50px 40px; border-radius: 16px; box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3); margin-bottom: 20px; text-align: center; border: 3px solid #d4c5a9; }
        .header h1 { font-size: 48px; color: #1a4d2e; margin-bottom: 8px; font-weight: 700; letter-spacing: 2px; text-shadow: 2px 2px 4px rgba(255,255,255,0.3); }
        .header p { color: #3d5a47; font-size: 18px; font-style: italic; margin-bottom: 5px; }
        .last-updated { font-size: 13px; color: #4d6d5a; margin-top: 10px; }
        .predictions-banner { background: linear-gradient(135deg, #f5f1e8 0%, #ece5d7 100%); padding: 25px 40px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); margin-bottom: 20px; border-left: 5px solid #2d5a3d; }
        .predictions-title { font-size: 18px; font-weight: 700; color: #1a4d2e; margin-bottom: 20px; text-align: center; letter-spacing: 1px; }
        .predictions-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .prediction-card { background: linear-gradient(135deg, #fff 0%, #faf8f4 100%); padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); transition: transform .3s, box-shadow .3s; border: 2px solid transparent; }
        .prediction-card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
        .prediction-card.low { border-color: #4a7c59; }
        .prediction-card.medium { border-color: #c1a76c; }
        .prediction-card.high { border-color: #c1566c; }
        .prediction-timeframe { font-size: 13px; font-weight: 700; text-transform: uppercase; color: #6d7d75; margin-bottom: 10px; letter-spacing: 0.5px; }
        .prediction-percentage { font-size: 42px; font-weight: bold; margin-bottom: 8px; }
        .prediction-percentage.low { color: #4a7c59; }
        .prediction-percentage.medium { color: #c1a76c; }
        .prediction-percentage.high { color: #c1566c; }
        .prediction-label { font-size: 12px; color: #6d7d75; font-style: italic; }
        .header-actions { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-bottom:30px; }
        .grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:20px; margin-bottom:30px; }
        .stat-card { background: linear-gradient(135deg,#f5f1e8 0%,#ece5d7 100%); padding:25px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.15); border-left:5px solid #2d5a3d; transition: transform .3s, box-shadow .3s; }
        .stat-card:hover { transform: translateY(-4px); box-shadow:0 6px 16px rgba(0,0,0,0.2); }
        .stat-label { color:#5a6d62; font-size:12px; font-weight:700; text-transform:uppercase; margin-bottom:10px; letter-spacing:1px; }
        .stat-value { font-size:36px; font-weight:bold; color:#1a4d2e; margin-bottom:8px; }
        .stat-subtitle { color:#6d7d75; font-size:14px; }
        .chart-container { background: linear-gradient(135deg,#f5f1e8 0%,#ece5d7 100%); padding:30px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.15); margin-bottom:30px; border-top:4px solid #2d5a3d; }
        .chart-title { font-size:20px; font-weight:700; color:#1a4d2e; margin-bottom:20px; padding-bottom:15px; border-bottom:2px solid #c4b5a0; font-family: 'Georgia', serif; }
        .chart-wrapper { position:relative; height:300px; margin-bottom:20px; display:flex; align-items:center; justify-content:center; padding:6px 0; }
        .chart-wrapper--left { justify-content:flex-start; }
        .two-column { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:30px; }
        .insights-section { background: linear-gradient(135deg,#f5f1e8 0%,#ece5d7 100%); padding:30px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.15); margin-bottom:30px; border-top:4px solid #2d5a3d; }
        .insights-title { font-size:20px; font-weight:700; color:#1a4d2e; margin-bottom:20px; padding-bottom:15px; border-bottom:2px solid #c4b5a0; }
        .insight-item { display:flex; align-items:center; padding:15px 0; border-bottom:1px solid #d4c5a9; }
        .insight-item:last-child { border-bottom:none; }
        .insight-icon { width:40px; height:40px; border-radius:50%; background:#2d5a3d; display:flex; align-items:center; justify-content:center; font-size:20px; margin-right:15px; flex-shrink:0; color:#f5f1e8; }
        .insight-content h3 { color:#1a4d2e; font-size:15px; margin-bottom:5px; font-weight:700; }
        .insight-content p { color:#6d7d75; font-size:14px; }
        .data-table { overflow-x:auto; background: linear-gradient(135deg,#f5f1e8 0%,#ece5d7 100%); padding:30px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.15); margin-bottom:30px; border-top:4px solid #2d5a3d; }
        .data-table-title { font-size:20px; font-weight:700; color:#1a4d2e; margin-bottom:20px; padding-bottom:15px; border-bottom:2px solid #c4b5a0; }
        table { width:100%; border-collapse:collapse; }
        thead { background:#2d5a3d; }
        th { padding:14px; text-align:left; font-weight:700; color:#f5f1e8; font-size:13px; text-transform:uppercase; border-bottom:2px solid #1a4d2e; letter-spacing:0.5px; }
        td { padding:12px 14px; border-bottom:1px solid #d4c5a9; color:#2d3e35; font-size:14px; }
        tr:hover { background:#e8dfd2; }
        .food-yes { background:#4a7c59; color:#f5f1e8; padding:5px 10px; border-radius:4px; font-size:12px; font-weight:600; }
        .food-no { background:#8b7355; color:#f5f1e8; padding:5px 10px; border-radius:4px; font-size:12px; font-weight:600; }
        .period-yes { background:#c1566c; color:#f5f1e8; padding:5px 10px; border-radius:4px; font-size:12px; font-weight:600; }
        .period-no { background:#7a9d8e; color:#f5f1e8; padding:5px 10px; border-radius:4px; font-size:12px; font-weight:600; }
        .loading { text-align:center; color:#6d7d75; padding:40px; }
        .error { background:#a06858; color:#f5f1e8; padding:20px; border-radius:12px; margin-bottom:30px; }
        .stat-card.alert { border-left-color:#c1566c; background: linear-gradient(135deg,#faf6f1 0%,#f5ede4 100%); }
        .health-insight { background: linear-gradient(135deg,#e8f5e9 0%,#c8e6c9 100%); border-left-color:#4a7c59; }
        .health-insight .stat-value { color:#2d5a3d; }
        .correlation-positive { color:#4a7c59; font-weight:700; }
        .correlation-negative { color:#c1566c; font-weight:700; }
        .correlation-neutral { color:#8b7355; font-weight:700; }
        .stat-value.alert { color:#c1566c; }
        .btn { background: linear-gradient(135deg,#2d5a3d 0%,#1a4d2e 100%); color:#f5f1e8; padding:12px 24px; border:2px solid #1a4d2e; border-radius:8px; font-size:14px; font-weight:600; cursor:pointer; transition:all .3s; text-decoration:none; display:inline-block; font-family:'Georgia', serif; }
        .btn:hover { background: linear-gradient(135deg,#1a4d2e 0%,#0d3620 100%); transform: translateY(-2px); box-shadow:0 4px 12px rgba(0,0,0,0.3); }
        .btn:active { transform: translateY(0); }
        .table-controls { display:flex; gap:15px; margin-bottom:20px; flex-wrap:wrap; align-items:center; }
        .filter-group { display:flex; gap:10px; align-items:center; }
        .filter-group label { font-weight:600; color:#1a4d2e; font-size:13px; }
        .filter-group select, .filter-group input { padding:8px 12px; border:2px solid #d4c5a9; border-radius:6px; font-family:'Georgia', serif; color:#1a4d2e; background:#f5f1e8; }
        .filter-group select:focus, .filter-group input:focus { outline:none; border-color:#2d5a3d; box-shadow:0 0 0 3px rgba(45,90,61,0.1); }
        @media (max-width:1200px) { .two-column { grid-template-columns:1fr; } .header h1 { font-size:36px; } }
        @media (max-width:768px) { .header { padding:30px 20px; } .header h1 { font-size:28px; } .grid { grid-template-columns:1fr; } .table-controls { flex-direction:column; align-items:stretch; } .filter-group { flex-direction:column; align-items:stretch; } .filter-group select, .filter-group input { width:100%; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Kylie's Seizure Wellness Dashboard</h1>
            <p>Comprehensive health insights and tracking</p>
            <div class="last-updated">Last updated: <span id="lastUpdated">--</span></div>
        </div>

        <div class="predictions-banner" id="predictionsBanner">
            <div class="loading">Loading predictions...</div>
        </div>

        <div class="header-actions">
            <button class="btn" id="exportBtn" title="Download seizure data as CSV">Export Data</button>
            <button class="btn" id="refreshBtn" title="Refresh dashboard data">Refresh</button>
        </div>

        <div class="grid" id="statsGrid">
            <div class="loading">Loading data...</div>
        </div>

        <div class="insights-section" id="insightsSection">
            <div class="loading">Loading insights...</div>
        </div>

        <div class="grid" id="healthStatsGrid">
            <div class="loading">Loading health data...</div>
        </div>

        <div class="insights-section" id="healthInsightsSection">
            <div class="loading">Loading health insights...</div>
        </div>
        
        <div class="two-column">
            <div class="chart-container">
                <div class="chart-title">Seizure Risk Heatmap (Hour x Day of Week)</div>
                <div class="chart-wrapper" id="heatmapWrapper">
                    <!-- canvas will be centered inside wrapper; sizing handled in JS for crispness -->
                    <canvas id="heatmapCanvas" style="display:block; margin:0 auto; max-width:100%; height:100%;"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">Hour of Day Analysis</div>
                <div class="chart-wrapper">
                    <canvas id="hourChart"></canvas>
                </div>
            </div>
        </div>

        <div class="two-column">
            <div class="chart-container">
                <div class="chart-title">Duration Distribution</div>
                <div class="chart-wrapper">
                    <canvas id="durationChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">Monthly Trends</div>
                <div class="chart-wrapper">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>
        </div>

        <div class="two-column">
            <div class="chart-container">
                <div class="chart-title">Time Between Seizures</div>
                <div class="chart-wrapper">
                    <canvas id="timeIntervalChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">Day of Week Pattern</div>
                <div class="chart-wrapper">
                    <canvas id="dayChart"></canvas>
                </div>
            </div>
        </div>

        <div class="two-column">
            <div class="chart-container">
                <div class="chart-title">Duration vs Food Intake</div>
                <div class="chart-wrapper">
                    <canvas id="foodChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">Pain Tracking with Seizure Events</div>
                <div class="chart-wrapper">
                    <canvas id="painChart"></canvas>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-title">Sleep Metrics (3 Days Before Seizures vs Baseline)</div>
            <div class="chart-wrapper">
                <canvas id="sleepComparisonChart"></canvas>
            </div>
        </div>

        <div class="two-column">
            <div class="chart-container">
                <div class="chart-title">Resting Heart Rate Trend with Seizure Markers</div>
                <div class="chart-wrapper">
                    <canvas id="hrTrendChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">Activity Level (Walking Distance) Timeline</div>
                <div class="chart-wrapper">
                    <canvas id="activityTrendChart"></canvas>
                </div>
            </div>
        </div>

        <div class="two-column">
            <div class="chart-container">
                <div class="chart-title">Sleep Debt Accumulation (3-Day & 7-Day)</div>
                <div class="chart-wrapper">
                    <canvas id="sleepDebtChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">Sleep Stage Ratios (%)</div>
                <div class="chart-wrapper">
                    <canvas id="sleepRatiosChart"></canvas>
                </div>
            </div>
        </div>

        <div class="data-table">
            <div class="data-table-title">Recent Seizure Records</div>
            <div class="table-controls">
                <div class="filter-group">
                    <label for="periodFilter">Period:</label>
                    <select id="periodFilter">
                        <option value="all">All</option>
                        <option value="yes">During Period</option>
                        <option value="no">Not During Period</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="foodFilter">Food:</label>
                    <select id="foodFilter">
                        <option value="all">All</option>
                        <option value="yes">With Food</option>
                        <option value="no">Without Food</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="dateFilter">From Date:</label>
                    <input type="date" id="dateFilter">
                </div>
            </div>
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Date & Time</th>
                        <th>Duration (seconds)</th>
                        <th>Hour of Day</th>
                        <th>Day of Week</th>
                        <th>Period</th>
                        <th>Food Eaten</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="6" class="loading">Loading data...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const charts = {};
        let dataCache = null;
        let lastLoadTime = 0;
        const MIN_LOAD_INTERVAL = 5000; // Minimum 5 seconds between manual loads

        function renderPredictions(predictions) {
            const banner = document.getElementById('predictionsBanner');
            
            if (!predictions || Object.keys(predictions).length === 0) {
                banner.style.display = 'none';
                return;
            }
            
            banner.style.display = 'block';
            
            const getRiskClass = (percentage) => {
                if (percentage < 15) return 'low';
                if (percentage < 35) return 'medium';
                return 'high';
            };
            
            const getRiskLabel = (percentage) => {
                if (percentage < 15) return 'Low Risk';
                if (percentage < 35) return 'Moderate Risk';
                return 'High Risk';
            };
            
            const pred24 = predictions['24h'] || 0;
            const pred48 = predictions['48h'] || 0;
            const pred72 = predictions['72h'] || 0;
            
            banner.innerHTML = `
                <div class="predictions-title">üîÆ Seizure Risk Predictions</div>
                <div class="predictions-grid">
                    <div class="prediction-card ${getRiskClass(pred24)}">
                        <div class="prediction-timeframe">Next 24 Hours</div>
                        <div class="prediction-percentage ${getRiskClass(pred24)}">${pred24.toFixed(1)}%</div>
                        <div class="prediction-label">${getRiskLabel(pred24)}</div>
                    </div>
                    <div class="prediction-card ${getRiskClass(pred48)}">
                        <div class="prediction-timeframe">Next 48 Hours</div>
                        <div class="prediction-percentage ${getRiskClass(pred48)}">${pred48.toFixed(1)}%</div>
                        <div class="prediction-label">${getRiskLabel(pred48)}</div>
                    </div>
                    <div class="prediction-card ${getRiskClass(pred72)}">
                        <div class="prediction-timeframe">Next 72 Hours</div>
                        <div class="prediction-percentage ${getRiskClass(pred72)}">${pred72.toFixed(1)}%</div>
                        <div class="prediction-label">${getRiskLabel(pred72)}</div>
                    </div>
                </div>
            `;
        }

        async function loadData() {
            const now = Date.now();
            if (now - lastLoadTime < MIN_LOAD_INTERVAL) {
                return; // Prevent rapid repeated loads
            }
            lastLoadTime = now;
            
            try {
                const response = await fetch('/api/data');
                if (!response.ok) throw new Error('Network response not ok');
                
                const data = await response.json();
                dataCache = data;
                
                document.getElementById('lastUpdated').textContent = data.last_updated;
                renderStats(data.statistics);
                renderPredictions(data.predictions);
                renderInsights(data);
                renderCharts(data.charts);
                renderPainChart(data.pain_charts);
                renderTable(data.charts.timeline);
                
                if (typeof renderHealthStats === 'function' && data.health_insights) {
                    renderHealthStats(data.health_insights);
                }
                if (typeof renderHealthInsights === 'function' && data.health_insights) {
                    renderHealthInsights(data.health_insights);
                }
                if (typeof renderHealthCharts === 'function' && data.health_charts) {
                    renderHealthCharts(data.health_charts);
                }
            } catch (error) {
                console.error('Error loading data:', error);
                if (!dataCache) {
                    document.getElementById('statsGrid').innerHTML = '<div class="error">Failed to load seizure data</div>';
                }
            }
        }

        function renderStats(stats) {
            const grid = document.getElementById('statsGrid');
            if (!stats || Object.keys(stats).length === 0) { grid.innerHTML = '<div class="error">No data available</div>'; return; }
            const isAlert = stats.recent_seizures_7_days > 3;
            grid.innerHTML = `
                <div class="stat-card"><div class="stat-label">Total Seizures</div><div class="stat-value">${stats.total_seizures}</div><div class="stat-subtitle">Since ${stats.first_record}</div></div>
                <div class="stat-card ${isAlert ? 'alert' : ''}"><div class="stat-label">Last 7 Days</div><div class="stat-value ${isAlert ? 'alert' : ''}">${stats.recent_seizures_7_days}</div><div class="stat-subtitle">${stats.avg_per_week.toFixed(1)} seizures/week</div></div>
                <div class="stat-card"><div class="stat-label">Average Duration</div><div class="stat-value">${stats.avg_duration}s</div><div class="stat-subtitle">Min: ${stats.min_duration}s | Max: ${stats.max_duration}s</div></div>
                <div class="stat-card"><div class="stat-label">Days Tracked</div><div class="stat-value">${stats.date_range_days}</div><div class="stat-subtitle">${stats.avg_per_day.toFixed(2)} seizures/day</div></div>
                <div class="stat-card"><div class="stat-label">With Food</div><div class="stat-value">${stats.food_eaten_count}</div><div class="stat-subtitle">${((stats.food_eaten_count / stats.total_seizures) * 100).toFixed(1)}%</div></div>
                <div class="stat-card"><div class="stat-label">Without Food</div><div class="stat-value">${stats.no_food_count}</div><div class="stat-subtitle">${((stats.no_food_count / stats.total_seizures) * 100).toFixed(1)}%</div></div>
            `;
        }

        function renderInsights(data) {
            const section = document.getElementById('insightsSection');
            if (!data || !data.charts || !data.charts.timeline) {
                section.innerHTML = '<div class="insights-title">üìä Seizure Insights</div><div class="insight-item"><div class="insight-content"><p>No insights available</p></div></div>';
                return;
            }

            const stats = data.statistics || {};
            let insights = '<div class="insights-title">üìä Seizure Insights</div>';

            if (stats.period_related_count > 0) {
                const periodRatio = (stats.period_related_count / stats.total_seizures * 100).toFixed(1);
                insights += `
                    <div class="insight-item">
                        <div class="insight-icon">ü©∏</div>
                        <div class="insight-content">
                            <h3>Period Correlation</h3>
                            <p>Minimal seizures occurred during menstrual cycle</p>
                        </div>
                    </div>
                `;
            }

            if (stats.food_eaten_count > 0) {
                const foodRatio = (stats.food_eaten_count / stats.total_seizures * 100).toFixed(1);
                insights += `
                    <div class="insight-item">
                        <div class="insight-icon">üçΩÔ∏è</div>
                        <div class="insight-content">
                            <h3>Food Intake Pattern</h3>
                            <p>${foodRatio}% of seizures occurred after eating</p>
                        </div>
                    </div>
                `;
            }

            if (data.charts.duration_stats) {
                const durStats = data.charts.duration_stats;
                insights += `
                    <div class="insight-item">
                        <div class="insight-icon">‚è±Ô∏è</div>
                        <div class="insight-content">
                            <h3>Duration Patterns</h3>
                            <p>Average duration: ${durStats.mean}s | Range: ${durStats.min}s - ${durStats.max}s</p>
                        </div>
                    </div>
                `;
            }

            section.innerHTML = insights;
        }

        function renderHealthStats(healthInsights) {
            const grid = document.getElementById('healthStatsGrid');
            if (!healthInsights || Object.keys(healthInsights).length === 0) {
                grid.innerHTML = '<div class="stat-card"><div class="stat-subtitle">No Apple Watch data available yet</div></div>';
                return;
            }

            const sleep = healthInsights.sleep_analysis || {};
            const hr = healthInsights.heart_rate_analysis || {};
            const activity = healthInsights.activity_analysis || {};

            let html = '';

            // Sleep before seizures
            if (sleep.before_seizure_avg_total !== undefined) {
                const sleepDiff = sleep.baseline_avg_total ? (sleep.before_seizure_avg_total - sleep.baseline_avg_total).toFixed(1) : 0;
                const sleepClass = sleepDiff < -0.5 ? 'alert' : '';
                html += `
                    <div class="stat-card health-insight ${sleepClass}">
                        <div class="stat-label">Sleep Before Seizures</div>
                        <div class="stat-value">${sleep.before_seizure_avg_total.toFixed(1)}h</div>
                        <div class="stat-subtitle">Baseline: ${sleep.baseline_avg_total ? sleep.baseline_avg_total.toFixed(1) : 'N/A'}h (${sleepDiff > 0 ? '+' : ''}${sleepDiff}h)</div>
                    </div>`;
            }

            // Deep sleep comparison
            if (sleep.before_seizure_avg_deep !== undefined) {
                const deepDiff = sleep.baseline_avg_deep ? (sleep.before_seizure_avg_deep - sleep.baseline_avg_deep).toFixed(1) : 0;
                html += `
                    <div class="stat-card health-insight">
                        <div class="stat-label">Deep Sleep Before Seizures</div>
                        <div class="stat-value">${sleep.before_seizure_avg_deep.toFixed(1)}h</div>
                        <div class="stat-subtitle">Baseline: ${sleep.baseline_avg_deep ? sleep.baseline_avg_deep.toFixed(1) : 'N/A'}h (${deepDiff > 0 ? '+' : ''}${deepDiff}h)</div>
                    </div>`;
            }

            // REM sleep comparison
            if (sleep.before_seizure_avg_rem !== undefined) {
                const remDiff = sleep.baseline_avg_rem ? (sleep.before_seizure_avg_rem - sleep.baseline_avg_rem).toFixed(1) : 0;
                html += `
                    <div class="stat-card health-insight">
                        <div class="stat-label">REM Sleep Before Seizures</div>
                        <div class="stat-value">${sleep.before_seizure_avg_rem.toFixed(1)}h</div>
                        <div class="stat-subtitle">Baseline: ${sleep.baseline_avg_rem ? sleep.baseline_avg_rem.toFixed(1) : 'N/A'}h (${remDiff > 0 ? '+' : ''}${remDiff}h)</div>
                    </div>`;
            }

            // Resting heart rate on seizure days
            if (hr.seizure_day_min_hr !== undefined) {
                const hrDiff = hr.baseline_min_hr ? (hr.seizure_day_min_hr - hr.baseline_min_hr).toFixed(0) : 0;
                const hrClass = hrDiff > 5 ? 'alert' : '';
                html += `
                    <div class="stat-card health-insight ${hrClass}">
                        <div class="stat-label">Resting HR (Seizure Days)</div>
                        <div class="stat-value">${hr.seizure_day_min_hr.toFixed(0)} bpm</div>
                        <div class="stat-subtitle">Baseline: ${hr.baseline_min_hr ? hr.baseline_min_hr.toFixed(0) : 'N/A'} bpm (${hrDiff > 0 ? '+' : ''}${hrDiff})</div>
                    </div>`;
            }

            // Activity before seizures
            if (activity.before_seizure_avg_distance !== undefined) {
                const actDiff = activity.baseline_avg_distance ? (activity.before_seizure_avg_distance - activity.baseline_avg_distance).toFixed(2) : 0;
                html += `
                    <div class="stat-card health-insight">
                        <div class="stat-label">Activity Before Seizures</div>
                        <div class="stat-value">${activity.before_seizure_avg_distance.toFixed(2)} mi</div>
                        <div class="stat-subtitle">Baseline: ${activity.baseline_avg_distance ? activity.baseline_avg_distance.toFixed(2) : 'N/A'} mi (${actDiff > 0 ? '+' : ''}${actDiff})</div>
                    </div>`;
            }

            grid.innerHTML = html || '<div class="stat-card"><div class="stat-subtitle">Calculating health metrics...</div></div>';
        }

        function renderHealthInsights(healthInsights) {
            const section = document.getElementById('healthInsightsSection');
            if (!healthInsights || Object.keys(healthInsights).length === 0) {
                section.innerHTML = '<div class="insights-title">üè• Health Insights</div><div class="insight-item"><div class="insight-content"><p>No Apple Watch data available yet</p></div></div>';
                return;
            }

            const sleep = healthInsights.sleep_analysis || {};
            const hr = healthInsights.heart_rate_analysis || {};
            const activity = healthInsights.activity_analysis || {};

            let insights = '<div class="insights-title">üè• Health & Wellness Insights</div>';

            // Sleep quality insight
            if (sleep.before_seizure_avg_total && sleep.baseline_avg_total) {
                const sleepDiff = sleep.before_seizure_avg_total - sleep.baseline_avg_total;
                const sleepImpact = sleepDiff < -0.5 ? 'significantly less' : sleepDiff < -0.2 ? 'slightly less' : 'similar';
                const sleepClass = sleepDiff < -0.5 ? 'correlation-negative' : sleepDiff > 0.2 ? 'correlation-positive' : 'correlation-neutral';
                
                insights += `
                    <div class="insight-item">
                        <div class="insight-icon">üò¥</div>
                        <div class="insight-content">
                            <h3>Sleep Quality Pattern</h3>
                            <p>Sleep 1-3 days before seizures is <span class="${sleepClass}">${sleepImpact}</span> than baseline (${Math.abs(sleepDiff).toFixed(1)}h difference)</p>
                        </div>
                    </div>`;
            }

            // Deep sleep insight
            if (sleep.before_seizure_avg_deep && sleep.baseline_avg_deep) {
                const deepDiff = sleep.before_seizure_avg_deep - sleep.baseline_avg_deep;
                const deepPercentChange = ((deepDiff / sleep.baseline_avg_deep) * 100).toFixed(0);
                
                insights += `
                    <div class="insight-item">
                        <div class="insight-icon">üåô</div>
                        <div class="insight-content">
                            <h3>Deep Sleep Correlation</h3>
                            <p>Deep sleep before seizures: ${sleep.before_seizure_avg_deep.toFixed(1)}h vs baseline ${sleep.baseline_avg_deep.toFixed(1)}h (${deepPercentChange > 0 ? '+' : ''}${deepPercentChange}%)</p>
                        </div>
                    </div>`;
            }

            // Heart rate insight
            if (hr.seizure_day_min_hr && hr.baseline_min_hr) {
                const hrDiff = hr.seizure_day_min_hr - hr.baseline_min_hr;
                const hrStatus = hrDiff > 5 ? 'elevated' : hrDiff < -5 ? 'lower' : 'similar to';
                const hrClass = hrDiff > 5 ? 'correlation-negative' : hrDiff < -5 ? 'correlation-positive' : 'correlation-neutral';
                
                insights += `
                    <div class="insight-item">
                        <div class="insight-icon">‚ù§Ô∏è</div>
                        <div class="insight-content">
                            <h3>Resting Heart Rate Pattern</h3>
                            <p>Resting HR on seizure days is <span class="${hrClass}">${hrStatus}</span> baseline (${hrDiff > 0 ? '+' : ''}${hrDiff.toFixed(0)} bpm)</p>
                        </div>
                    </div>`;
            }

            // Activity insight
            if (activity.before_seizure_avg_distance !== undefined && activity.baseline_avg_distance) {
                const actDiff = activity.before_seizure_avg_distance - activity.baseline_avg_distance;
                const actStatus = actDiff > 0.5 ? 'higher' : actDiff < -0.5 ? 'lower' : 'similar to';
                
                insights += `
                    <div class="insight-item">
                        <div class="insight-icon">üö∂</div>
                        <div class="insight-content">
                            <h3>Activity Level Correlation</h3>
                            <p>Activity 1-2 days before seizures is ${actStatus} baseline (${actDiff > 0 ? '+' : ''}${actDiff.toFixed(2)} mi)</p>
                        </div>
                    </div>`;
            }

            section.innerHTML = insights;
        }

        function renderHealthCharts(healthCharts) {
            if (!healthCharts || Object.keys(healthCharts).length === 0) return;

            // Sleep comparison chart
            const sleepCompCtx = document.getElementById('sleepComparisonChart').getContext('2d');
            if (charts.sleepComparison) charts.sleepComparison.destroy();
            
            if (healthCharts.sleep_timeline && healthCharts.sleep_timeline.length > 0) {
                const sleepData = healthCharts.sleep_timeline;
                const seizureMarkers = healthCharts.seizure_markers || [];
                
                charts.sleepComparison = new Chart(sleepCompCtx, {
                    type: 'line',
                    data: {
                        labels: sleepData.map(d => d.date_str),
                        datasets: [
                            {
                                label: 'Total Sleep',
                                data: sleepData.map(d => d.total_sleep),
                                borderColor: '#2d5a3d',
                                backgroundColor: 'rgba(45,90,61,0.1)',
                                tension: 0.2,
                                fill: true,
                                pointRadius: 2,
                                pointHoverRadius: 3,
                                borderWidth: 1.5
                            },
                            {
                                label: 'Deep Sleep',
                                data: sleepData.map(d => d.deep_sleep),
                                borderColor: '#4a7c59',
                                backgroundColor: 'rgba(74,124,89,0.1)',
                                tension: 0.2,
                                fill: true,
                                pointRadius: 2,
                                pointHoverRadius: 3,
                                borderWidth: 1.5
                            },
                            {
                                label: 'REM Sleep',
                                data: sleepData.map(d => d.rem_sleep),
                                borderColor: '#6fa86f',
                                backgroundColor: 'rgba(111,168,111,0.1)',
                                tension: 0.2,
                                fill: true,
                                pointRadius: 2,
                                pointHoverRadius: 3,
                                borderWidth: 1.5
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: { duration: 0 },
                        plugins: {
                            legend: { display: true, position: 'top' }
                        },
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: 'Hours' } },
                            x: { ticks: { maxRotation: 45, minRotation: 45, autoSkip: true, maxTicksLimit: 10 } }
                        }
                    }
                });
            }

            // Heart rate trend chart
            const hrTrendCtx = document.getElementById('hrTrendChart').getContext('2d');
            if (charts.hrTrend) charts.hrTrend.destroy();
            
            if (healthCharts.hr_timeline && healthCharts.hr_timeline.length > 0) {
                const hrData = healthCharts.hr_timeline;
                const seizureMarkers = healthCharts.seizure_markers || [];
                const seizurePoints = hrData.map(d => seizureMarkers.includes(d.date_str) ? d.avg_hr : null);
                
                charts.hrTrend = new Chart(hrTrendCtx, {
                    type: 'line',
                    data: {
                        labels: hrData.map(d => d.date_str),
                        datasets: [
                            {
                                label: 'Average HR',
                                data: hrData.map(d => d.avg_hr),
                                borderColor: '#2d5a3d',
                                backgroundColor: 'rgba(45,90,61,0.1)',
                                tension: 0.2,
                                fill: true,
                                pointRadius: 2,
                                pointHoverRadius: 3,
                                borderWidth: 1.5
                            },
                            {
                                label: 'Seizure Days',
                                data: seizurePoints,
                                pointRadius: 6,
                                pointBackgroundColor: '#c1566c',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2,
                                showLine: false
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: { duration: 0 },
                        plugins: { legend: { display: true, position: 'top' } },
                        scales: {
                            y: { title: { display: true, text: 'Heart Rate (bpm)' } },
                            x: { ticks: { maxRotation: 45, minRotation: 45, autoSkip: true, maxTicksLimit: 10 } }
                        }
                    }
                });
            }

            // Activity trend chart
            const activityTrendCtx = document.getElementById('activityTrendChart').getContext('2d');
            if (charts.activityTrend) charts.activityTrend.destroy();
            
            if (healthCharts.activity_timeline && healthCharts.activity_timeline.length > 0) {
                const actData = healthCharts.activity_timeline;
                const seizureMarkers = healthCharts.seizure_markers || [];
                const seizurePoints = actData.map(d => seizureMarkers.includes(d.date_str) ? d.walking_distance : null);
                
                charts.activityTrend = new Chart(activityTrendCtx, {
                    type: 'bar',
                    data: {
                        labels: actData.map(d => d.date_str),
                        datasets: [
                            {
                                label: 'Walking Distance',
                                data: actData.map(d => d.walking_distance),
                                backgroundColor: '#4a7c59',
                                borderWidth: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: { duration: 0 },
                        plugins: { legend: { display: true, position: 'top' } },
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: 'Miles' } },
                            x: { ticks: { maxRotation: 45, minRotation: 45, autoSkip: true, maxTicksLimit: 10 } }
                        }
                    }
                });
            }

            // Sleep debt chart
            const sleepDebtCtx = document.getElementById('sleepDebtChart').getContext('2d');
            if (charts.sleepDebt) charts.sleepDebt.destroy();
            
            if (healthCharts.sleep_debt && healthCharts.sleep_debt.length > 0) {
                const debtData = healthCharts.sleep_debt;
                
                charts.sleepDebt = new Chart(sleepDebtCtx, {
                    type: 'line',
                    data: {
                        labels: debtData.map(d => d.date),
                        datasets: [
                            {
                                label: '3-Day Sleep Debt',
                                data: debtData.map(d => d.cumulative_debt_3day),
                                borderColor: '#c1566c',
                                backgroundColor: 'rgba(193,86,108,0.1)',
                                tension: 0.2,
                                fill: true,
                                pointRadius: 1.5,
                                borderWidth: 1.5
                            },
                            {
                                label: '7-Day Sleep Debt',
                                data: debtData.map(d => d.cumulative_debt_7day),
                                borderColor: '#8b7355',
                                backgroundColor: 'rgba(139,115,85,0.1)',
                                tension: 0.2,
                                fill: true,
                                pointRadius: 1.5,
                                borderWidth: 1.5
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: { duration: 0 },
                        plugins: { 
                            legend: { display: true, position: 'top' }
                        },
                        scales: {
                            y: { title: { display: true, text: 'Hours of Sleep Deficit' } },
                            x: { ticks: { maxRotation: 45, minRotation: 45, autoSkip: true, maxTicksLimit: 10 } }
                        }
                    }
                });
            }

            // Sleep ratios chart
            const sleepRatiosCtx = document.getElementById('sleepRatiosChart').getContext('2d');
            if (charts.sleepRatios) charts.sleepRatios.destroy();
            
            if (healthCharts.sleep_ratios && healthCharts.sleep_ratios.length > 0) {
                const ratioData = healthCharts.sleep_ratios;
                
                charts.sleepRatios = new Chart(sleepRatiosCtx, {
                    type: 'line',
                    data: {
                        labels: ratioData.map(d => d.date_str),
                        datasets: [
                            {
                                label: 'Deep Sleep %',
                                data: ratioData.map(d => d.deep_ratio),
                                borderColor: '#2d5a3d',
                                backgroundColor: 'rgba(45,90,61,0.1)',
                                tension: 0.2,
                                fill: true,
                                pointRadius: 2,
                                borderWidth: 1.5
                            },
                            {
                                label: 'REM Sleep %',
                                data: ratioData.map(d => d.rem_ratio),
                                borderColor: '#4a7c59',
                                backgroundColor: 'rgba(74,124,89,0.1)',
                                tension: 0.2,
                                fill: true,
                                pointRadius: 2,
                                borderWidth: 1.5
                            },
                            {
                                label: 'Core Sleep %',
                                data: ratioData.map(d => d.core_ratio),
                                borderColor: '#6fa86f',
                                backgroundColor: 'rgba(111,168,111,0.1)',
                                tension: 0.2,
                                fill: true,
                                pointRadius: 2,
                                borderWidth: 1.5
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: { duration: 0 },
                        plugins: { legend: { display: true, position: 'top' } },
                        scales: {
                            y: { beginAtZero: true, max: 100, title: { display: true, text: 'Percentage of Total Sleep' } },
                            x: { ticks: { maxRotation: 45, minRotation: 45, autoSkip: true, maxTicksLimit: 10 } }
                        }
                    }
                });
            }
        }


        // Horizontal heatmap: hours across X (military 00-23), days down Y
        function createHeatmap(heatmapData) {
            const canvas = document.getElementById('heatmapCanvas');
            const ctx = canvas.getContext('2d');

            const hours = 24;
            const days = 7;
            const cellSize = 30;            // pixel size per cell (logical)
            const labelLeftWidth = 62;     // width reserved for day labels (reducing pushes graph left)
            const labelTopHeight = 28;     // height reserved for hour labels
            const padding = 8;

            // logical pixel dimensions (will be scaled by DPR)
            const pixelWidth = labelLeftWidth + (hours * cellSize) + (padding * 2);
            const pixelHeight = labelTopHeight + (days * cellSize) + (padding * 2);

            const dpr = window.devicePixelRatio || 1;
            canvas.width = Math.round(pixelWidth * dpr);
            canvas.height = Math.round(pixelHeight * dpr);

            // Make canvas responsive but keep aspect: do not force width:100% which was pushing content to the right.
            canvas.style.width = 'auto';
            canvas.style.height = '100%';
            canvas.style.maxWidth = '100%';
            canvas.style.display = 'block';
            canvas.style.margin = '0 auto';

            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

            // Clear
            ctx.clearRect(0, 0, pixelWidth, pixelHeight);

            // color scaling
            const maxCount = Math.max(...(heatmapData.map(d => d.count)), 1);
            const getColor = (count) => {
                if (!count) return '#ece5d7';
                const intensity = count / maxCount;
                if (intensity < 0.33) return '#c8d9c8';
                if (intensity < 0.66) return '#6fa86f';
                return '#2d5a3d';
            };

            // Draw hour labels (00 .. 23) across the top
            ctx.font = '12px Georgia';
            ctx.fillStyle = '#1a4d2e';
            ctx.textBaseline = 'middle';
            ctx.textAlign = 'center';
            for (let hour = 0; hour < hours; hour++) {
                const label = String(hour).padStart(2, '0');
                const x = labelLeftWidth + padding + (hour * cellSize) + (cellSize / 2);
                const y = padding + (labelTopHeight / 2);
                ctx.fillText(label, x, y);
            }

            // Day labels on the left, right-aligned
            const dayLabels = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
            ctx.textAlign = 'right';
            for (let d = 0; d < days; d++) {
                const x = labelLeftWidth - 8;
                const y = padding + labelTopHeight + (d * cellSize) + (cellSize / 2);
                ctx.fillText(dayLabels[d], x, y);
            }

            // Draw cells
            heatmapData.forEach(cell => {
                // Expect cell to have: hour (0-23), day_index (0-6), count
                const x = labelLeftWidth + padding + (cell.hour * cellSize);
                const y = labelTopHeight + padding + (cell.day_index * cellSize);
                ctx.fillStyle = getColor(cell.count);
                ctx.fillRect(x, y, cellSize, cellSize);

                // cell border
                ctx.strokeStyle = '#d4c5a9';
                ctx.lineWidth = 1;
                ctx.strokeRect(x + 0.5, y + 0.5, cellSize - 1, cellSize - 1);

                // count label (small)
                if (cell.count && cell.count > 0) {
                    ctx.fillStyle = cell.count > maxCount * 0.5 ? '#f5f1e8' : '#1a4d2e';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(String(cell.count), x + (cellSize / 2), y + (cellSize / 2));
                }
            });
        }

        function renderCharts(chartsData) {
            // Monthly
            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
            if (charts.monthly) charts.monthly.destroy();
            charts.monthly = new Chart(monthlyCtx, {
                type: 'line',
                data: { labels: chartsData.monthly_frequency.map(m => m.month), datasets: [{ label: 'Seizures', data: chartsData.monthly_frequency.map(m => m.count), borderColor: '#2d5a3d', backgroundColor: 'rgba(45,90,61,0.15)', tension: 0.2, fill: true, pointRadius: 3, pointHoverRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, animation: { duration: 0 }, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true }, x: { grid: { display: false } } } }
            });

            // Duration
            const durationCtx = document.getElementById('durationChart').getContext('2d');
            if (charts.duration) charts.duration.destroy();
            charts.duration = new Chart(durationCtx, {
                type: 'bar',
                data: { labels: chartsData.duration_distribution.map(d => d.range), datasets: [{ label: 'Count', data: chartsData.duration_distribution.map(d => d.count), backgroundColor: '#4a7c59' }] },
                options: { responsive: true, maintainAspectRatio: false, animation: { duration: 0 }, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true }, x: { grid: { display: false } } } }
            });

            // Time between seizures
            const timeIntervalCtx = document.getElementById('timeIntervalChart').getContext('2d');
            if (charts.timeInterval) charts.timeInterval.destroy();
            charts.timeInterval = new Chart(timeIntervalCtx, {
                type: 'line',
                data: { labels: chartsData.time_between_seizures.map((_, i) => `Interval ${i + 1}`), datasets: [{ label: 'Days', data: chartsData.time_between_seizures.map(t => t.days_since_previous), borderColor: '#c1566c', backgroundColor: 'rgba(193,86,108,0.1)', tension: 0.2, fill: true, pointRadius: 3 }] },
                options: { responsive: true, maintainAspectRatio: false, animation: { duration: 0 }, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true }, x: { grid: { color: 'rgba(45,90,61,0.05)' } } } }
            });

            // Heatmap (horizontal - hours across, days down)
            createHeatmap(chartsData.heatmap);

            // Hour of day
            const hourCtx = document.getElementById('hourChart').getContext('2d');
            if (charts.hour) charts.hour.destroy();
            const hourLabels = chartsData.hour_frequency.map(h => String(h.hour).padStart(2, '0'));
            charts.hour = new Chart(hourCtx, {
                type: 'bar',
                data: { labels: hourLabels, datasets: [{ label: 'Seizures', data: chartsData.hour_frequency.map(h => h.count), backgroundColor: '#2d5a3d' }] },
                options: { responsive: true, maintainAspectRatio: false, animation: { duration: 0 }, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true }, x: { grid: { display: false } } } }
            });

            // Day of week
            const dayCtx = document.getElementById('dayChart').getContext('2d');
            if (charts.day) charts.day.destroy();
            charts.day = new Chart(dayCtx, {
                type: 'bar',
                data: { labels: chartsData.day_frequency.map(d => d.day), datasets: [{ label: 'Seizures', data: chartsData.day_frequency.map(d => d.count), backgroundColor: '#4a7c59' }] },
                options: { responsive: true, maintainAspectRatio: false, animation: { duration: 0 }, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true }, x: { grid: { display: false } } } }
            });

            // Food vs duration
            const foodCtx = document.getElementById('foodChart').getContext('2d');
            if (charts.food) charts.food.destroy();
            charts.food = new Chart(foodCtx, {
                type: 'bar',
                data: { labels: ['With Food','Without Food'], datasets: [{ label: 'Avg Duration', data: [chartsData.food_analysis.food_eaten_avg, chartsData.food_analysis.no_food_avg], backgroundColor: ['#4a7c59','#8b7355'] }] },
                options: { responsive: true, maintainAspectRatio: false, animation: { duration: 0 }, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true }, x: { grid: { display: false } } } }
            });
        }

        function renderPainChart(painData) {
            const painCtx = document.getElementById('painChart').getContext('2d');
            if (charts.pain) charts.pain.destroy();
            
            if (!painData || !painData.pain_timeline || painData.pain_timeline.length === 0) {
                return;
            }
            
            const painLabels = painData.pain_timeline.map(p => p.timestamp);
            const painValues = painData.pain_timeline.map(p => p.pain);
            const seizureData = [];
            
            painData.seizure_markers.forEach(seizure => {
                const seizureTimestamp = seizure.timestamp;
                const exactIndex = painLabels.indexOf(seizureTimestamp);
                
                if (exactIndex !== -1) {
                    seizureData.push(painValues[exactIndex]);
                } else {
                    const seizureTime = new Date(seizureTimestamp).getTime();
                    let closestIndex = 0;
                    let closestDiff = Math.abs(new Date(painLabels[0]).getTime() - seizureTime);
                    
                    for (let i = 1; i < painLabels.length; i++) {
                        const diff = Math.abs(new Date(painLabels[i]).getTime() - seizureTime);
                        if (diff < closestDiff) {
                            closestDiff = diff;
                            closestIndex = i;
                        }
                    }
                    seizureData.push(painValues[closestIndex]);
                }
            });
            
            const allTimestamps = [...painLabels];
            const seizureTimestamps = painData.seizure_markers.map(s => s.timestamp);
            
            seizureTimestamps.forEach(st => {
                if (!allTimestamps.includes(st)) {
                    allTimestamps.push(st);
                }
            });
            
            allTimestamps.sort((a, b) => new Date(a) - new Date(b));
            
            const allPainValues = allTimestamps.map(ts => {
                const idx = painLabels.indexOf(ts);
                return idx !== -1 ? painValues[idx] : null;
            });
            
            const allSeizureValues = allTimestamps.map(ts => {
                const seizureIdx = seizureTimestamps.indexOf(ts);
                if (seizureIdx !== -1) {
                    const painIdx = painLabels.indexOf(ts);
                    if (painIdx !== -1) {
                        return painValues[painIdx];
                    } else {
                        const seizureTime = new Date(ts).getTime();
                        let closestIdx = 0;
                        let closestDiff = Math.abs(new Date(painLabels[0]).getTime() - seizureTime);
                        
                        for (let i = 1; i < painLabels.length; i++) {
                            const diff = Math.abs(new Date(painLabels[i]).getTime() - seizureTime);
                            if (diff < closestDiff) {
                                closestDiff = diff;
                                closestIdx = i;
                            }
                        }
                        return painValues[closestIdx];
                    }
                }
                return null;
            });
            
            const datasets = [
                {
                    label: 'Pain Level',
                    data: allPainValues,
                    borderColor: '#2d5a3d',
                    backgroundColor: 'rgba(45,90,61,0.1)',
                    tension: 0.3,
                    fill: true,
                    pointRadius: 2,
                    pointHoverRadius: 3,
                    pointBackgroundColor: '#2d5a3d',
                    spanGaps: true,
                    borderWidth: 1.5
                }
            ];
            
            if (allSeizureValues.some(v => v !== null)) {
                datasets.push({
                    label: 'Seizure Event',
                    data: allSeizureValues,
                    pointRadius: 6,
                    pointHoverRadius: 7,
                    pointBackgroundColor: '#c1566c',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    showLine: false,
                    pointStyle: 'circle'
                });
            }
            
            charts.pain = new Chart(painCtx, {
                type: 'line',
                data: {
                    labels: allTimestamps,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 0 },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    if (context.dataset.label === 'Seizure Event') {
                                        return 'Seizure occurred (Pain: ' + context.parsed.y + ')';
                                    }
                                    return 'Pain: ' + context.parsed.y;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10,
                            title: {
                                display: true,
                                text: 'Pain Level (0-10)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                autoSkip: true,
                                maxTicksLimit: 10
                            }
                        }
                    }
                }
            });
        }

        function renderTable(timeline) {
            const tbody = document.getElementById('tableBody');
            if (!timeline || timeline.length === 0) { tbody.innerHTML = '<tr><td colspan="6">No data</td></tr>'; return; }
            window.originalTimeline = timeline;
            applyTableFilters(timeline);
        }

        function applyTableFilters(timeline) {
            const tbody = document.getElementById('tableBody');
            const periodFilter = document.getElementById('periodFilter').value;
            const foodFilter = document.getElementById('foodFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            let filtered = timeline;
            if (periodFilter !== 'all') filtered = filtered.filter(r => r.period === (periodFilter === 'yes'));
            if (foodFilter !== 'all') filtered = filtered.filter(r => r.food_eaten === (foodFilter === 'yes'));
            if (dateFilter) filtered = filtered.filter(r => r.timestamp.split(' ')[0] >= dateFilter);
            if (filtered.length === 0) { tbody.innerHTML = '<tr><td colspan="6">No records</td></tr>'; return; }
            tbody.innerHTML = filtered.slice(0, 50).map(record => `<tr><td>${record.timestamp}</td><td>${record.duration_seconds}s</td><td>${String(record.hour_of_day).padStart(2,'0')}:00</td><td>${record.day_of_week}</td><td><span class="${record.period ? 'period-yes' : 'period-no'}">${record.period ? 'Yes' : 'No'}</span></td><td><span class="${record.food_eaten ? 'food-yes' : 'food-no'}">${record.food_eaten ? 'Yes' : 'No'}</span></td></tr>`).join('');
        }

        let filterTimeout;
        function initializeFilterListeners() {
            const applyFilters = () => {
                clearTimeout(filterTimeout);
                filterTimeout = setTimeout(() => {
                    if (window.originalTimeline) applyTableFilters(window.originalTimeline);
                }, 300); // Debounce for 300ms
            };
            document.getElementById('periodFilter').addEventListener('change', applyFilters);
            document.getElementById('foodFilter').addEventListener('change', applyFilters);
            document.getElementById('dateFilter').addEventListener('change', applyFilters);
        }

        function exportData() {
            const exportBtn = document.getElementById('exportBtn');
            const originalText = exportBtn.textContent;
            exportBtn.textContent = 'Exporting...';
            exportBtn.disabled = true;
            
            fetch('/api/export', { priority: 'high' })
                .then(response => { if (!response.ok) throw new Error('Export failed'); return response.blob(); })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'kylie_seizure_data.csv';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    exportBtn.textContent = 'Downloaded!';
                    setTimeout(() => { exportBtn.textContent = originalText; exportBtn.disabled = false; }, 2000);
                })
                .catch(error => { console.error('Export error:', error); exportBtn.textContent = 'Error'; setTimeout(() => { exportBtn.textContent = originalText; exportBtn.disabled = false; }, 2000); });
        }

        loadData();
        initializeFilterListeners();
        document.getElementById('exportBtn').addEventListener('click', exportData);
        document.getElementById('refreshBtn').addEventListener('click', () => { document.getElementById('refreshBtn').textContent = 'Refreshing...'; loadData(); setTimeout(() => { document.getElementById('refreshBtn').textContent = 'Refresh'; }, 1000); });
        setInterval(loadData, 120000);
    </script>
</body>
</html>
