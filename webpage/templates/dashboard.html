<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seizure Monitoring Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Georgia', 'Garamond', serif; background: linear-gradient(135deg, #1a4d2e 0%, #2d5a3d 50%, #3d6b4f 100%); min-height: 100vh; padding: 20px; color: #2d3e35; }
        .container { max-width: 1600px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #8b9a7c 0%, #a0b896 100%); padding: 50px 40px; border-radius: 16px; box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3); margin-bottom: 20px; text-align: center; border: 3px solid #d4c5a9; }
        .header h1 { font-size: 48px; color: #1a4d2e; margin-bottom: 8px; font-weight: 700; letter-spacing: 2px; text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.3); }
        .header p { color: #3d5a47; font-size: 18px; font-style: italic; margin-bottom: 5px; }
        .last-updated { font-size: 13px; color: #4d6d5a; margin-top: 10px; }
        .header-actions { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-bottom: 30px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #f5f1e8 0%, #ece5d7 100%); padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); border-left: 5px solid #2d5a3d; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2); }
        .stat-label { color: #5a6d62; font-size: 12px; font-weight: 700; text-transform: uppercase; margin-bottom: 10px; letter-spacing: 1px; }
        .stat-value { font-size: 36px; font-weight: bold; color: #1a4d2e; margin-bottom: 8px; }
        .stat-subtitle { color: #6d7d75; font-size: 14px; }
        .chart-container { background: linear-gradient(135deg, #f5f1e8 0%, #ece5d7 100%); padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); margin-bottom: 30px; border-top: 4px solid #2d5a3d; }
        .chart-title { font-size: 20px; font-weight: 700; color: #1a4d2e; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #c4b5a0; font-family: 'Georgia', serif; }
        .chart-wrapper { position: relative; height: 300px; margin-bottom: 20px; }
        .two-column { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .insights-section { background: linear-gradient(135deg, #f5f1e8 0%, #ece5d7 100%); padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); margin-bottom: 30px; border-top: 4px solid #2d5a3d; }
        .insights-title { font-size: 20px; font-weight: 700; color: #1a4d2e; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #c4b5a0; }
        .insight-item { display: flex; align-items: center; padding: 15px 0; border-bottom: 1px solid #d4c5a9; }
        .insight-item:last-child { border-bottom: none; }
        .insight-icon { width: 40px; height: 40px; border-radius: 50%; background: #2d5a3d; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 15px; flex-shrink: 0; }
        .insight-content h3 { color: #1a4d2e; font-size: 15px; margin-bottom: 5px; font-weight: 700; }
        .insight-content p { color: #6d7d75; font-size: 14px; }
        .data-table { overflow-x: auto; background: linear-gradient(135deg, #f5f1e8 0%, #ece5d7 100%); padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); margin-bottom: 30px; border-top: 4px solid #2d5a3d; }
        .data-table-title { font-size: 20px; font-weight: 700; color: #1a4d2e; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #c4b5a0; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: #2d5a3d; }
        th { padding: 14px; text-align: left; font-weight: 700; color: #f5f1e8; font-size: 13px; text-transform: uppercase; border-bottom: 2px solid #1a4d2e; letter-spacing: 0.5px; }
        td { padding: 12px 14px; border-bottom: 1px solid #d4c5a9; color: #2d3e35; font-size: 14px; }
        tr:hover { background: #e8dfd2; }
        .food-yes { background: #4a7c59; color: #f5f1e8; padding: 5px 10px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .food-no { background: #8b7355; color: #f5f1e8; padding: 5px 10px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .period-yes { background: #c1566c; color: #f5f1e8; padding: 5px 10px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .period-no { background: #7a9d8e; color: #f5f1e8; padding: 5px 10px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .loading { text-align: center; color: #6d7d75; padding: 40px; }
        .error { background: #a06858; color: #f5f1e8; padding: 20px; border-radius: 12px; margin-bottom: 30px; }
        .stat-card.alert { border-left-color: #c1566c; background: linear-gradient(135deg, #faf6f1 0%, #f5ede4 100%); }
        .stat-value.alert { color: #c1566c; }
        .btn { background: linear-gradient(135deg, #2d5a3d 0%, #1a4d2e 100%); color: #f5f1e8; padding: 12px 24px; border: 2px solid #1a4d2e; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-block; font-family: 'Georgia', serif; }
        .btn:hover { background: linear-gradient(135deg, #1a4d2e 0%, #0d3620 100%); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); }
        .btn:active { transform: translateY(0); }
        .table-controls { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .filter-group { display: flex; gap: 10px; align-items: center; }
        .filter-group label { font-weight: 600; color: #1a4d2e; font-size: 13px; }
        .filter-group select, .filter-group input { padding: 8px 12px; border: 2px solid #d4c5a9; border-radius: 6px; font-family: 'Georgia', serif; color: #1a4d2e; background: #f5f1e8; }
        .filter-group select:focus, .filter-group input:focus { outline: none; border-color: #2d5a3d; box-shadow: 0 0 0 3px rgba(45, 90, 61, 0.1); }
        @media (max-width: 1200px) { .two-column { grid-template-columns: 1fr; } .header h1 { font-size: 36px; } }
        @media (max-width: 768px) { .header { padding: 30px 20px; } .header h1 { font-size: 28px; } .grid { grid-template-columns: 1fr; } .table-controls { flex-direction: column; align-items: stretch; } .filter-group { flex-direction: column; align-items: stretch; } .filter-group select, .filter-group input { width: 100%; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Kylie's Seizure Wellness Dashboard</h1>
            <p>Comprehensive health insights and tracking</p>
            <div class="last-updated">Last updated: <span id="lastUpdated">--</span></div>
        </div>

        <div class="header-actions">
            <button class="btn" id="exportBtn" title="Download seizure data as CSV">Export Data</button>
            <button class="btn" id="refreshBtn" title="Refresh dashboard data">Refresh</button>
        </div>

        <div class="grid" id="statsGrid">
            <div class="loading">Loading data...</div>
        </div>

        <div class="insights-section" id="insightsSection">
            <div class="loading">Loading insights...</div>
        </div>

        <div class="two-column">
            <div class="chart-container">
                <div class="chart-title">Seizure Risk Heatmap (Hour x Day of Week)</div>
                <div id="heatmapContainer" style="display: flex; justify-content: center; padding: 10px 0;">
                    <canvas id="heatmapCanvas" style="max-width: 100%; height: auto;"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">Hour of Day Analysis</div>
                <div class="chart-wrapper">
                    <canvas id="hourChart"></canvas>
                </div>
            </div>
        </div>

        <div class="two-column">
            <div class="chart-container">
                <div class="chart-title">Duration Distribution</div>
                <div class="chart-wrapper">
                    <canvas id="durationChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">Monthly Trends</div>
                <div class="chart-wrapper">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>
        </div>

        <div class="two-column">
            <div class="chart-container">
                <div class="chart-title">Time Between Seizures</div>
                <div class="chart-wrapper">
                    <canvas id="timeIntervalChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">Day of Week Pattern</div>
                <div class="chart-wrapper">
                    <canvas id="dayChart"></canvas>
                </div>
            </div>
        </div>

        <div class="two-column">
            <div class="chart-container">
                <div class="chart-title">Duration vs Food Intake</div>
                <div class="chart-wrapper">
                    <canvas id="foodChart"></canvas>
                </div>
            </div>
        </div>

        <div class="data-table">
            <div class="data-table-title">Recent Seizure Records</div>
            <div class="table-controls">
                <div class="filter-group">
                    <label for="periodFilter">Period:</label>
                    <select id="periodFilter">
                        <option value="all">All</option>
                        <option value="yes">During Period</option>
                        <option value="no">Not During Period</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="foodFilter">Food:</label>
                    <select id="foodFilter">
                        <option value="all">All</option>
                        <option value="yes">With Food</option>
                        <option value="no">Without Food</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="dateFilter">From Date:</label>
                    <input type="date" id="dateFilter">
                </div>
            </div>
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Date & Time</th>
                        <th>Duration (seconds)</th>
                        <th>Hour of Day</th>
                        <th>Day of Week</th>
                        <th>Period</th>
                        <th>Food Eaten</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="6" class="loading">Loading data...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const charts = {};

        async function loadData() {
            try {
                const response = await fetch('/api/data');
                const data = await response.json();
                document.getElementById('lastUpdated').textContent = data.last_updated;
                renderStats(data.statistics);
                renderInsights(data);
                renderCharts(data.charts);
                renderTable(data.charts.timeline);
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('statsGrid').innerHTML = '<div class="error">Failed to load seizure data</div>';
            }
        }

        function renderStats(stats) {
            const grid = document.getElementById('statsGrid');
            if (!stats || Object.keys(stats).length === 0) { grid.innerHTML = '<div class="error">No data available</div>'; return; }
            const isAlert = stats.recent_seizures_7_days > 3;
            grid.innerHTML = `
                <div class="stat-card"><div class="stat-label">Total Seizures</div><div class="stat-value">${stats.total_seizures}</div><div class="stat-subtitle">Since ${stats.first_record}</div></div>
                <div class="stat-card ${isAlert ? 'alert' : ''}"><div class="stat-label">Last 7 Days</div><div class="stat-value ${isAlert ? 'alert' : ''}">${stats.recent_seizures_7_days}</div><div class="stat-subtitle">${stats.avg_per_week.toFixed(1)} seizures/week</div></div>
                <div class="stat-card"><div class="stat-label">Average Duration</div><div class="stat-value">${stats.avg_duration}s</div><div class="stat-subtitle">Min: ${stats.min_duration}s | Max: ${stats.max_duration}s</div></div>
                <div class="stat-card"><div class="stat-label">Days Tracked</div><div class="stat-value">${stats.date_range_days}</div><div class="stat-subtitle">${stats.avg_per_day.toFixed(2)} seizures/day</div></div>
                <div class="stat-card"><div class="stat-label">With Food</div><div class="stat-value">${stats.food_eaten_count}</div><div class="stat-subtitle">${((stats.food_eaten_count / stats.total_seizures) * 100).toFixed(1)}%</div></div>
                <div class="stat-card"><div class="stat-label">Without Food</div><div class="stat-value">${stats.no_food_count}</div><div class="stat-subtitle">${((stats.no_food_count / stats.total_seizures) * 100).toFixed(1)}%</div></div>
            `;
        }

        function renderInsights(data) {
            const stats = data.statistics;
            const charts = data.charts;
            const section = document.getElementById('insightsSection');
            if (!stats) { section.innerHTML = '<div class="error">No insights</div>'; return; }
            
            let mostCommonHour = 12, maxCount = 0;
            charts.hour_frequency.forEach(item => { if (item.count > maxCount) { maxCount = item.count; mostCommonHour = item.hour; } });
            const period = mostCommonHour >= 12 ? 'PM' : 'AM';
            const displayHour = mostCommonHour % 12 === 0 ? 12 : mostCommonHour % 12;
            
            let mostCommonDay = 'Monday';
            maxCount = 0;
            charts.day_frequency.forEach(item => { if (item.count > maxCount) { maxCount = item.count; mostCommonDay = item.day; } });

            section.innerHTML = `
                <div class="insights-title">Key Insights</div>
                <div class="insight-item"><div class="insight-icon">‚è∞</div><div class="insight-content"><h3>Peak Time</h3><p>${displayHour}:00 ${period}</p></div></div>
                <div class="insight-item"><div class="insight-icon">üìÜ</div><div class="insight-content"><h3>Weekly Peak</h3><p>${mostCommonDay}</p></div></div>
                <div class="insight-item"><div class="insight-icon">üìä</div><div class="insight-content"><h3>Data Summary</h3><p>${stats.date_range_days} days tracked, ${stats.total_seizures} seizures</p></div></div>
            `;
        }

        function createHeatmap(heatmapData) {
            const canvas = document.getElementById('heatmapCanvas');
            const ctx = canvas.getContext('2d');
            const hours = 24, days = 7, cellSize = 30, labelWidth = 50, labelHeight = 25, padding = 10;
            canvas.width = labelWidth + (days * cellSize) + (padding * 2);
            canvas.height = labelHeight + (hours * cellSize) + (padding * 2);
            const maxCount = Math.max(...heatmapData.map(d => d.count), 1);
            const getColor = (count) => {
                if (count === 0) return '#ece5d7';
                const intensity = count / maxCount;
                if (intensity < 0.33) return '#c8d9c8';
                if (intensity < 0.66) return '#6fa86f';
                return '#2d5a3d';
            };
            const dayLabels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            ctx.font = '12px Georgia';
            ctx.textAlign = 'center';
            ctx.fillStyle = '#1a4d2e';
            for (let i = 0; i < days; i++) {
                ctx.fillText(dayLabels[i], labelWidth + (i * cellSize) + (cellSize / 2), padding + (labelHeight / 2));
            }
            ctx.textAlign = 'right';
            for (let hour = 0; hour < hours; hour++) {
                const p = hour >= 12 ? 'PM' : 'AM';
                const h = hour % 12 === 0 ? 12 : hour % 12;
                ctx.fillText(`${h} ${p}`, labelWidth - 10, labelHeight + padding + (hour * cellSize) + (cellSize / 2));
            }
            heatmapData.forEach(cell => {
                const x = labelWidth + padding + (cell.day_index * cellSize);
                const y = labelHeight + padding + (cell.hour * cellSize);
                const color = getColor(cell.count);
                ctx.fillStyle = color;
                ctx.fillRect(x, y, cellSize, cellSize);
                ctx.strokeStyle = '#d4c5a9';
                ctx.lineWidth = 1;
                ctx.strokeRect(x, y, cellSize, cellSize);
                if (cell.count > 0) {
                    ctx.fillStyle = cell.count > maxCount * 0.5 ? '#f5f1e8' : '#1a4d2e';
                    ctx.font = 'bold 14px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(cell.count, x + (cellSize / 2), y + (cellSize / 2));
                }
            });
        }

        function renderCharts(chartsData) {
            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
            if (charts.monthly) charts.monthly.destroy();
            charts.monthly = new Chart(monthlyCtx, { type: 'line', data: { labels: chartsData.monthly_frequency.map(m => m.month), datasets: [{ label: 'Seizures', data: chartsData.monthly_frequency.map(m => m.count), borderColor: '#2d5a3d', backgroundColor: 'rgba(45, 90, 61, 0.15)', tension: 0.4, fill: true }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true }, x: { grid: { display: false } } } } });

            const durationCtx = document.getElementById('durationChart').getContext('2d');
            if (charts.duration) charts.duration.destroy();
            charts.duration = new Chart(durationCtx, { type: 'bar', data: { labels: chartsData.duration_distribution.map(d => d.range), datasets: [{ label: 'Count', data: chartsData.duration_distribution.map(d => d.count), backgroundColor: '#4a7c59' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true }, x: { grid: { display: false } } } } });

            const timeIntervalCtx = document.getElementById('timeIntervalChart').getContext('2d');
            if (charts.timeInterval) charts.timeInterval.destroy();
            charts.timeInterval = new Chart(timeIntervalCtx, { type: 'line', data: { labels: chartsData.time_between_seizures.map((_, i) => `Interval ${i + 1}`), datasets: [{ label: 'Days', data: chartsData.time_between_seizures.map(t => t.days_since_previous), borderColor: '#c1566c', backgroundColor: 'rgba(193, 86, 108, 0.1)', tension: 0.4, fill: true }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true }, x: { grid: { color: 'rgba(45, 90, 61, 0.05)' } } } } });

            createHeatmap(chartsData.heatmap);

            const hourCtx = document.getElementById('hourChart').getContext('2d');
            if (charts.hour) charts.hour.destroy();
            const hourLabels = chartsData.hour_frequency.map(h => { const p = h.hour >= 12 ? 'PM' : 'AM'; const hh = h.hour % 12 === 0 ? 12 : h.hour % 12; return `${hh} ${p}`; });
            charts.hour = new Chart(hourCtx, { type: 'bar', data: { labels: hourLabels, datasets: [{ label: 'Seizures', data: chartsData.hour_frequency.map(h => h.count), backgroundColor: '#2d5a3d' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true }, x: { grid: { display: false } } } } });

            const dayCtx = document.getElementById('dayChart').getContext('2d');
            if (charts.day) charts.day.destroy();
            charts.day = new Chart(dayCtx, { type: 'bar', data: { labels: chartsData.day_frequency.map(d => d.day), datasets: [{ label: 'Seizures', data: chartsData.day_frequency.map(d => d.count), backgroundColor: '#4a7c59' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true }, x: { grid: { display: false } } } } });

            const foodCtx = document.getElementById('foodChart').getContext('2d');
            if (charts.food) charts.food.destroy();
            charts.food = new Chart(foodCtx, { type: 'bar', data: { labels: ['With Food', 'Without Food'], datasets: [{ label: 'Avg Duration', data: [chartsData.food_analysis.food_eaten_avg, chartsData.food_analysis.no_food_avg], backgroundColor: ['#4a7c59', '#8b7355'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true }, x: { grid: { display: false } } } } });
        }

        function renderTable(timeline) {
            const tbody = document.getElementById('tableBody');
            if (!timeline || timeline.length === 0) { tbody.innerHTML = '<tr><td colspan="6">No data</td></tr>'; return; }
            window.originalTimeline = timeline;
            applyTableFilters(timeline);
        }

        function applyTableFilters(timeline) {
            const tbody = document.getElementById('tableBody');
            const periodFilter = document.getElementById('periodFilter').value;
            const foodFilter = document.getElementById('foodFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            let filtered = timeline;
            if (periodFilter !== 'all') filtered = filtered.filter(r => r.period === (periodFilter === 'yes'));
            if (foodFilter !== 'all') filtered = filtered.filter(r => r.food_eaten === (foodFilter === 'yes'));
            if (dateFilter) filtered = filtered.filter(r => r.timestamp.split(' ')[0] >= dateFilter);
            if (filtered.length === 0) { tbody.innerHTML = '<tr><td colspan="6">No records</td></tr>'; return; }
            tbody.innerHTML = filtered.slice(0, 50).map(record => `<tr><td>${record.timestamp}</td><td>${record.duration_seconds}s</td><td>${record.hour_of_day}:00</td><td>${record.day_of_week}</td><td><span class="${record.period ? 'period-yes' : 'period-no'}">${record.period ? 'Yes' : 'No'}</span></td><td><span class="${record.food_eaten ? 'food-yes' : 'food-no'}">${record.food_eaten ? 'Yes' : 'No'}</span></td></tr>`).join('');
        }

        function initializeFilterListeners() {
            document.getElementById('periodFilter').addEventListener('change', () => { if (window.originalTimeline) applyTableFilters(window.originalTimeline); });
            document.getElementById('foodFilter').addEventListener('change', () => { if (window.originalTimeline) applyTableFilters(window.originalTimeline); });
            document.getElementById('dateFilter').addEventListener('change', () => { if (window.originalTimeline) applyTableFilters(window.originalTimeline); });
        }

        function exportData() {
            const exportBtn = document.getElementById('exportBtn');
            const originalText = exportBtn.textContent;
            exportBtn.textContent = 'Exporting...';
            exportBtn.disabled = true;
            fetch('/api/export')
                .then(response => { if (!response.ok) throw new Error('Export failed'); return response.blob(); })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'kylie_seizure_data.csv';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    exportBtn.textContent = 'Downloaded!';
                    setTimeout(() => { exportBtn.textContent = originalText; exportBtn.disabled = false; }, 2000);
                })
                .catch(error => { console.error('Export error:', error); exportBtn.textContent = 'Error'; setTimeout(() => { exportBtn.textContent = originalText; exportBtn.disabled = false; }, 2000); });
        }

        loadData();
        initializeFilterListeners();
        document.getElementById('exportBtn').addEventListener('click', exportData);
        document.getElementById('refreshBtn').addEventListener('click', () => { document.getElementById('refreshBtn').textContent = 'Refreshing...'; loadData(); setTimeout(() => { document.getElementById('refreshBtn').textContent = 'Refresh'; }, 1000); });
        setInterval(loadData, 30000);
    </script>
</body>
</html>